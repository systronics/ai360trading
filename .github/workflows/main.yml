name: AlgoTradeBot

on:
  schedule:
    # Every 5 min, 08:30–16:29 IST (03:00–10:59 UTC), Mon–Fri
    - cron: '*/5 3-10 * * 1-5'

  workflow_dispatch:
    # ── Manual trigger with mode selector ──
    # Go to GitHub → Actions → AlgoTradeBot → Run workflow
    # Pick a mode from the dropdown and click Run
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'trade'
        type: choice
        options:
          - trade          # Normal trading cycle (same as auto schedule)
          - test_telegram  # Send test message — verify Telegram is working
          - daily_summary  # Send full portfolio summary anytime on demand

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gspread oauth2client requests pytz

      - name: Run Trading Bot
        env:
          GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # BOT_MODE from workflow_dispatch input.
          # For scheduled cron runs BOT_MODE is empty → defaults to 'trade' in Python.
          BOT_MODE: ${{ github.event.inputs.mode }}
        run: python -u trading_bot.py
