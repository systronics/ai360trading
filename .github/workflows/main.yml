name: AlgoTradeBot
on:
  schedule:
    # Runs every 2 minutes from 4:00-10:00 UTC (9:30 AM - 3:30 PM IST)
    # Monday to Friday only
    - cron: '*/2 4-10 * * 1-5'
  
  workflow_dispatch: # Allows manual testing anytime

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # Increased buffer for safety
    
    # Prevents concurrent runs - CRITICAL for trading
    concurrency:
      group: trading-bot-single
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dhanhq gspread oauth2client pandas pyotp pytz requests
      
      - name: Verify market hours (IST timezone check)
        run: |
          CURRENT_UTC_HOUR=$(date -u +%H)
          CURRENT_UTC_MIN=$(date -u +%M)
          echo "Current UTC time: $CURRENT_UTC_HOUR:$CURRENT_UTC_MIN"
          
          # 4:00 UTC = 9:30 AM IST, 10:00 UTC = 3:30 PM IST
          if [ $CURRENT_UTC_HOUR -ge 4 ] && [ $CURRENT_UTC_HOUR -le 10 ]; then
            echo "‚úÖ Within market hours - proceeding"
          else
            echo "‚è∏Ô∏è Outside market hours - skipping"
            exit 0
          fi
      
      - name: Run trading bot
        env:
          GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
          DHAN_CLIENT_ID: ${{ secrets.DHAN_CLIENT_ID }}
          DHAN_TOTP_KEY: ${{ secrets.DHAN_TOTP_KEY }}
          DHAN_PIN: ${{ secrets.DHAN_PIN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "üöÄ Starting trading bot at $(date)"
          python -u trading_bot.py
          echo "‚úÖ Trading bot completed at $(date)"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            *.log
            *.txt
          retention-days: 7
