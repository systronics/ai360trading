name: AlgoTradeBot

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# CHANGELOG vs original:
# 1. CRON FIXED: */5 (every 5 min) Mon–Fri 8:30–16:30 IST
# 2. SECRETS: mapped to match Python os.environ.get() names
# 3. BOT_MODE dropdown: trade / test_telegram / daily_summary / weekly_summary
# 4. Filename fixed: trading_bot.py
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

on:
  schedule:
    # Every 5 min, 08:30–16:29 IST (03:00–10:59 UTC), Mon–Fri
    - cron: '*/5 3-10 * * 1-5'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Bot run mode'
        required: false
        default: 'trade'
        type: choice
        options:
          - trade
          - test_telegram
          - daily_summary
          - weekly_summary

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gspread oauth2client requests pytz

      - name: Run Trading Bot
        env:
          GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BOT_MODE: ${{ github.event.inputs.mode || 'trade' }}
        run: |
          export BOT_MODE="${BOT_MODE:-trade}"
          echo "[MODE] $BOT_MODE"
          python -u trading_bot.py
